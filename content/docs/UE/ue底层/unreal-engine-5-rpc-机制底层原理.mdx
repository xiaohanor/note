---
title: Unreal Engine 5 RPC 机制底层原理
---
## RPC 的分类与约束 \[#rpc-的分类与约束]

Unreal 中的远程过程调用（RPC）通过在 C++ 函数前加上 UFUNCTION(Server/Client/NetMulticast) 关键字来声明。按照调用方向不同，RPC 分为三类[*\[1\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=%E6%89%80%E6%9C%89%E7%9A%84RPC%E9%83%BD%E9%9C%80%E8%A6%81%E5%A3%B0%E6%98%8E%E4%B8%BAUFUNCTION%E3%80%82%E5%9C%A8Unreal%E5%86%85%E9%83%A8%E6%9C%89%E4%B8%89%E7%A7%8DRPC%E6%9C%BA%E5%88%B6%EF%BC%8C)[*\[2\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/actor-owner-and-owning-connection-in-unreal-engine#:~:text=An%20actor%E2%80%99s%20owning%20connection%20is,send%20and%20execute%20the%20RPC)：

* **Client RPC**（Client）：由服务器调用，在拥有该Actor的客户端上执行。
* **Server RPC**（Server）：由客户端调用，在服务器上执行。
* **Multicast RPC**（NetMulticast）：由服务器调用，服务器自身以及所有相关客户端都执行（不依赖单一拥有者）。

需要注意，UE 要求 RPC 必须定义在 AActor 的子类中，并且该 Actor 必须开启复制（SetReplicates(true)）。此外，客户端调用向服务器的 RPC 时，调用方必须拥有该 Actor；服务器调用向客户端的 RPC 时，只有拥有者客户端会执行[*\[3\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=1%20They%20must%20be%20called,Multicast%20RPCs%20are%20an%20exception)[*\[2\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/actor-owner-and-owning-connection-in-unreal-engine#:~:text=An%20actor%E2%80%99s%20owning%20connection%20is,send%20and%20execute%20the%20RPC)。换言之，RPC 调用过程依赖 Actor 所属的“拥有者”(Owner)和其对应的网络连接（Owning Connection）[*\[4\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=UNetConnection,NetConnection%20%3A%20NULL%3B)[*\[2\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/actor-owner-and-owning-connection-in-unreal-engine#:~:text=An%20actor%E2%80%99s%20owning%20connection%20is,send%20and%20execute%20the%20RPC)。这些约束确保了错误的调用不会被处理，否则会在日志中看到类似“No owning connection for actor… Function will not be processed”的警告[*\[5\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=%3C...%3E%20Connection%20%3D%20Actor,else)[*\[2\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/actor-owner-and-owning-connection-in-unreal-engine#:~:text=An%20actor%E2%80%99s%20owning%20connection%20is,send%20and%20execute%20the%20RPC)。

Unreal 利用其反射系统为每个被标记为 RPC 的函数生成包装体。调用 RPC 时，开发者代码实际调用的是引擎自动生成的 stub 代码，该 stub 将函数名与参数通过 ProcessEvent 传递给网络系统。例如，ACharacter::ServerMovePacked RPC 在客户端被调用时，实际上会调用 ProcessEvent 将参数打包[*\[6\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=static%20FName%20NAME_ACharacter_ServerMovePacked%20%3D%20FName%28TEXT%28,Character_eventServerMovePacked_Parms%20Parms%3B%20Parms.PackedBits%3DPackedBits)，以便发送到服务器执行。引擎对 UObject 系列对象构建了统一的反射信息（UClass/UFunction/UProperty），从而能够在运行时按名称查找函数并调用[*\[7\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=1,%E5%9F%BA%E4%BA%8E%E4%BB%A5%E4%B8%8A%E4%B8%A4%E7%82%B9%EF%BC%8CUnreal%E5%8F%AF%E4%BB%A5%E6%96%B9%E4%BE%BF%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%B1%9E%E6%80%A7%E7%9A%84%E7%BC%96%E7%A0%81%E8%A7%A3%E7%A0%81%EF%BC%8C%E4%BB%A5%E5%8F%8A%E8%BF%9C%E7%A8%8B%E8%BF%87%E7%A8%8B%E5%87%BD%E6%95%B0%E5%8F%8A%E5%85%B6%E5%8F%82%E6%95%B0%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%8C%E5%B9%B6%E5%AE%9E%E7%8E%B0%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E3%80%82)。这套机制同时支持属性复制和 RPC 参数的序列化/反序列化，使 RPC 调用成为可能[*\[7\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=1,%E5%9F%BA%E4%BA%8E%E4%BB%A5%E4%B8%8A%E4%B8%A4%E7%82%B9%EF%BC%8CUnreal%E5%8F%AF%E4%BB%A5%E6%96%B9%E4%BE%BF%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%B1%9E%E6%80%A7%E7%9A%84%E7%BC%96%E7%A0%81%E8%A7%A3%E7%A0%81%EF%BC%8C%E4%BB%A5%E5%8F%8A%E8%BF%9C%E7%A8%8B%E8%BF%87%E7%A8%8B%E5%87%BD%E6%95%B0%E5%8F%8A%E5%85%B6%E5%8F%82%E6%95%B0%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%8C%E5%B9%B6%E5%AE%9E%E7%8E%B0%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E3%80%82)[*\[8\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=UNetDriver%3A%3AProcessRemoteFunctionForChannelPrivate%20void%20FRepLayout%3A%3ASendPropertiesForRPC%20FRepLayout%3A%3ASerializeProperties_r%20Cmd.Property,SerializeIntPacked%28%20NumPayloadBits)。

## RPC 调用的底层流程 \[#rpc-调用的底层流程]

当客户端或服务器发起 RPC 时，调用路径大致如下：

* **查找连接**：在执行 RPC 之前，引擎会首先检查 Actor 的拥有连接（Owning Connection）。在 UNetDriver::ProcessRemoteFunction 中，会调用 Actor->GetNetConnection() 来获取该 Actor 的连接指针[*\[5\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=%3C...%3E%20Connection%20%3D%20Actor,else)。对于 AActor，默认实现是返回其 Owner 的连接（若有的话）；对于 APlayerController，返回其 NetConnection[*\[4\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=UNetConnection,NetConnection%20%3A%20NULL%3B)。如果没有有效的连接（即 RPC 调用方不拥有该 Actor），则该 RPC 不会被处理[*\[5\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=%3C...%3E%20Connection%20%3D%20Actor,else)[*\[4\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=UNetConnection,NetConnection%20%3A%20NULL%3B)。
* **寻找/创建 ActorChannel**：拿到连接后，引擎在该连接的 ActorChannels 映射中查找对应的 UActorChannel（每个需要同步的 Actor 对象在连接上都对应一个通道）[*\[9\]*](https://blog.csdn.net/pizi0475/article/details/51780581#:~:text=1.%20UActorChannel%2A%C2%A0Ch%C2%A0%3D%C2%A0Connection)。如果未找到通道，就调用 Connection->CreateChannel(CHTYPE\_Actor,1) 来新建一个 ActorChannel[*\[9\]*](https://blog.csdn.net/pizi0475/article/details/51780581#:~:text=1.%20UActorChannel%2A%C2%A0Ch%C2%A0%3D%C2%A0Connection)。这个通道索引（ChannelIndex）在底层用于区分网络上的不同 Actor[*\[9\]*](https://blog.csdn.net/pizi0475/article/details/51780581#:~:text=1.%20UActorChannel%2A%C2%A0Ch%C2%A0%3D%C2%A0Connection)。建立通道时会自动把该 Actor 的初始生成信息加入首批发送数据，以便客户端或服务器知道要创建该 Actor 实例。
* **参数序列化与打包**：找到或创建 UActorChannel 后，InternalProcessRemoteFunction 会负责对函数参数进行编码。引擎使用 FRepLayout（反射生成的布局信息）来遍历函数参数，并调用各个参数的 NetSerialize 接口序列化数据[*\[8\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=UNetDriver%3A%3AProcessRemoteFunctionForChannelPrivate%20void%20FRepLayout%3A%3ASendPropertiesForRPC%20FRepLayout%3A%3ASerializeProperties_r%20Cmd.Property,SerializeIntPacked%28%20NumPayloadBits)。这部分逻辑一般在 FRepLayout::SendPropertiesForRPC 和内部的 SerializeProperties\_r 中完成，各参数值通过 FNetBitWriter 写入比特流（在内存中表现为 FOutBunch）[*\[8\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=UNetDriver%3A%3AProcessRemoteFunctionForChannelPrivate%20void%20FRepLayout%3A%3ASendPropertiesForRPC%20FRepLayout%3A%3ASerializeProperties_r%20Cmd.Property,SerializeIntPacked%28%20NumPayloadBits)[*\[10\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Engine/Net/FOutBunch#:~:text=Syntax)。最终，UActorChannel 会调用 WriteFieldHeaderAndPayload、WriteContentBlockPayload 等方法，把参数的字段头和有效载荷写入网络包[*\[8\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=UNetDriver%3A%3AProcessRemoteFunctionForChannelPrivate%20void%20FRepLayout%3A%3ASendPropertiesForRPC%20FRepLayout%3A%3ASerializeProperties_r%20Cmd.Property,SerializeIntPacked%28%20NumPayloadBits)。
* **可靠性管理**：对于非可靠 (unreliable) RPC，引擎会先将数据放入队列统一发送；而标记为可靠 (reliable) 的 RPC 则会立即发送，并在 UNetConnection 维护一个发送确认缓冲队列确保传输[*\[11\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=%E8%BF%99%E9%87%8C%E4%BB%8D%E7%84%B6%E6%9C%89%E5%87%A0%E4%B8%AA%E5%B0%8F%E7%BB%86%E8%8A%82%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%BC%BA%E8%B0%83%E4%B8%8B%EF%BC%9A)。可靠队列满或编码失败时会触发连接关闭，因此高频操作通常避免使用可靠 RPC[*\[11\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=%E8%BF%99%E9%87%8C%E4%BB%8D%E7%84%B6%E6%9C%89%E5%87%A0%E4%B8%AA%E5%B0%8F%E7%BB%86%E8%8A%82%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%BC%BA%E8%B0%83%E4%B8%8B%EF%BC%9A)。
* **发送与接收**：打包好的 FOutBunch 最终会通过 UNetConnection 调用底层 Socket 发送出去（SendRawBunch）。接收端的 UNetConnection 则通过对应的 UActorChannel::ReceivedBunch 和 ReceivedContentBlockPayload 等方法恢复比特流，并根据字段头解析出 RPC 的参数数据。最后，网络系统会调用接收端的 UNetDriver::ProcessRemoteFunction（或其子类），反射出要调用的 UFunction，并调用 ProcessEvent 执行目标函数。

整个流程中，反射系统和网络层紧密配合：首先根据 UFunction 信息构建 FRepLayout（包括参数类型和序号），然后用 FNetBitWriter 将参数编码进网络包[*\[8\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=UNetDriver%3A%3AProcessRemoteFunctionForChannelPrivate%20void%20FRepLayout%3A%3ASendPropertiesForRPC%20FRepLayout%3A%3ASerializeProperties_r%20Cmd.Property,SerializeIntPacked%28%20NumPayloadBits)[*\[10\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Engine/Net/FOutBunch#:~:text=Syntax)。接收时再反过来解析并调用函数。

## 网络复制与 Actor 生命周期管理 \[#网络复制与-actor-生命周期管理]

RPC 通信是双向的，但对象状态的复制（Replication）主要由服务器驱动。服务器每帧会执行 UNetDriver::ServerReplicateActors，循环处理所有标记复制的 Actors[*\[12\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/detailed-actor-replication-flow?application_version=4.27#:~:text=The%20bulk%20of%20actor%20replication,each%20connected%20client%20was%20updated)。具体流程包括：

* **筛选复制的 Actor**：首先列出所有 bReplicates=true 的 Actor，跳过最初设为 Dormant（沉睡状态）的对象[*\[13\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/detailed-actor-replication-flow?application_version=4.27#:~:text=,relevant%20list%20on%20the%20connection)。根据 NetUpdateFrequency 检查是否需要本帧更新，如果没有就跳过。
* **相关性判断**：引擎判断每个 Actor 是否对某连接相关（Relevancy）。如果 Actor 的 bOnlyRelevantToOwner=true，则只有拥有者连接才会考虑该 Actor[*\[14\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/detailed-actor-replication-flow?application_version=4.27#:~:text=,is%20called)；否则对所有客户端都判断 AActor::IsNetRelevantFor 条件[*\[15\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/detailed-actor-replication-flow?application_version=4.27#:~:text=,add%20to%20the%20considered%20list)。通过这些检查后，每个连接都有一份“待复制列表”。
* **打开/维护通道**：对待复制列表中的每个 Actor，如果该连接尚未为其打开通道，会检查客户端是否已加载对应关卡，以及调用 IsNetRelevantFor 决定是否需要复制。如果需要，就创建一个新的 ActorChannel 来开始同步[*\[16\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/detailed-actor-replication-flow?application_version=4.27#:~:text=,flow%20looks%20something%20like%20this)。如果连接已加载或长期不相关，则会关闭通道，销毁远端 Actor 副本。
* **复制数据**：通过 UChannel::ReplicateActor 将 Actor 状态发送给客户端[*\[16\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/detailed-actor-replication-flow?application_version=4.27#:~:text=,flow%20looks%20something%20like%20this)。ReplicateActor 会在第一次更新时序列化必要的初始信息（例如位置、旋转等），并在此时将角色的 Role （如第一人称的 ROLE\_AutonomousProxy）根据拥有关系调整为模拟角色（ROLE\_SimulatedProxy）[*\[16\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/detailed-actor-replication-flow?application_version=4.27#:~:text=,flow%20looks%20something%20like%20this)。然后依次调用 FRepLayout 将该 Actor 的所有已改变属性和组件属性写入网络包[*\[16\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/detailed-actor-replication-flow?application_version=4.27#:~:text=,flow%20looks%20something%20like%20this)。如果组件被删除，也会发送删除命令。
* **排序与带宽管理**：服务器可能会对待复制 Actors 按优先级排序，并在网络拥堵时调整更新频率[*\[17\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/detailed-actor-replication-flow?application_version=4.27#:~:text=,UChannel%3A%3AReplicateActor)。引擎提供钩子函数 PreReplication，允许开发者动态改变哪些属性需要在某帧复制[*\[18\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/detailed-actor-replication-flow?application_version=4.27#:~:text=,add%20to%20the%20considered%20list)。只要连接持续相关，渠道会一直保持打开状态，Actor 在客户端持续存在；否则连接断开后，客户端将销毁对应 Actor。

以上流程说明：**对象复制以通道为单位进行管理**。每个（连接，Actor） 对应一个 UActorChannel，通道开启时自动创建并复制 Actor 实例，通道关闭时销毁实例[*\[9\]*](https://blog.csdn.net/pizi0475/article/details/51780581#:~:text=1.%20UActorChannel%2A%C2%A0Ch%C2%A0%3D%C2%A0Connection)[*\[12\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/detailed-actor-replication-flow?application_version=4.27#:~:text=The%20bulk%20of%20actor%20replication,each%20connected%20client%20was%20updated)。服务器决定哪些 Actors 对哪些客户端是可见并需要同步，并通过通道按需发送数据。这一机制在流程和概念上与 RPC 类似，都依赖 FRepLayout 的布局来打包数据[*\[8\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=UNetDriver%3A%3AProcessRemoteFunctionForChannelPrivate%20void%20FRepLayout%3A%3ASendPropertiesForRPC%20FRepLayout%3A%3ASerializeProperties_r%20Cmd.Property,SerializeIntPacked%28%20NumPayloadBits)[*\[16\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/detailed-actor-replication-flow?application_version=4.27#:~:text=,flow%20looks%20something%20like%20this)。

## RPC 参数的序列化与反序列化 \[#rpc-参数的序列化与反序列化]

RPC 的参数和普通属性一样通过网络序列化传输。具体来说，引擎首先通过反射得到函数参数的列表和类型，然后在 FRepLayout::SerializeProperties\_r 中遍历各参数（Cmd.Property）。对于每个参数字段，调用其 NetSerialize 方法将值写入 FNetBitWriter[*\[8\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=UNetDriver%3A%3AProcessRemoteFunctionForChannelPrivate%20void%20FRepLayout%3A%3ASendPropertiesForRPC%20FRepLayout%3A%3ASerializeProperties_r%20Cmd.Property,SerializeIntPacked%28%20NumPayloadBits)。结果是一个二进制比特流，按序连在一起，并附加字段头信息。UActorChannel 的 WriteFieldHeaderAndPayload 会先写入参数数量、字段索引等头部，再写入实际的比特流有效载荷[*\[8\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=UNetDriver%3A%3AProcessRemoteFunctionForChannelPrivate%20void%20FRepLayout%3A%3ASendPropertiesForRPC%20FRepLayout%3A%3ASerializeProperties_r%20Cmd.Property,SerializeIntPacked%28%20NumPayloadBits)。这样，一次 RPC 调用就构造成一个或多个网络包发送。

这些数据的接收端，会按相同字段头解析出各个参数的比特流，并反向调用 NetSerialize 恢复参数值，最终通过 ProcessEvent 传入目标函数执行。对于非基本类型（如 UObject\* 或复杂 struct），引擎会在序列化时把对象引用映射成网络 GUID（NetGUID）[*\[19\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Engine/Net/FOutBunch#:~:text=Image%3A%20Public%20variable%20FString%20DebugString,58)[*\[20\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Core/Misc/FNetworkGUID#:~:text=class%20FNetworkGUID)。例如，FOutBunch 中的 ExportNetGUIDs 数组记录了此次 RPC 需要引用的所有对象的 GUID[*\[19\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Engine/Net/FOutBunch#:~:text=Image%3A%20Public%20variable%20FString%20DebugString,58)。接收端通过 UNetConnection 的 PackageMap 将这些 GUID 映射回本地对象指针，保证远端引用到正确的实例。

简而言之，RPC 机制复用了 Unreal 的属性复制架构：参数布局由 FRepLayout 定义，比特写入使用 FNetBitWriter（即 FOutBunch）收集数据，然后经由 UChannel 发送。接收时再解码并调用函数。[*\[8\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=UNetDriver%3A%3AProcessRemoteFunctionForChannelPrivate%20void%20FRepLayout%3A%3ASendPropertiesForRPC%20FRepLayout%3A%3ASerializeProperties_r%20Cmd.Property,SerializeIntPacked%28%20NumPayloadBits)[*\[10\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Engine/Net/FOutBunch#:~:text=Syntax)

## 关键引擎模块与源码组件 \[#关键引擎模块与源码组件]

* **UNetDriver**：网络驱动核心类。在服务器端通常是 UServerNetDriver（或 UE5 中的 Iris Replication Driver），在客户端是 ULocalNetDriver。UNetDriver 负责管理连接列表（服务器有 ClientConnections，客户端有一个 ServerConnection[*\[21\]*](https://blog.csdn.net/pizi0475/article/details/51780581#:~:text=1.%20class%C2%A0UNetConnection)），以及处理全局复制和 RPC。RPC 的入口是 UNetDriver::ProcessRemoteFunction（在子类 UDemoNetDriver、UNetDriver 中均有实现）[*\[22\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Engine/Engine/UNetDriver/ProcessRemoteFunction#:~:text=virtual%20void%20ProcessRemoteFunction%20,SubObject)。此函数调用 Actor->GetNetConnection() 检查所有权，然后调用 InternalProcessRemoteFunction 完成参数打包和发送[*\[5\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=%3C...%3E%20Connection%20%3D%20Actor,else)。
* **UNetConnection**：表示与某个远端的单一连接（TCP/UDP 连接）。客户端只有一条到服务器的连接，服务器对每个客户端有一个 UNetConnection。UNetConnection 维护了一个 ActorChannels 映射，将已同步的 Actor 对象映射到对应的 UActorChannel[*\[23\]*](https://blog.csdn.net/pizi0475/article/details/51780581#:~:text=nnel%EF%BC%8C%E6%88%91%E4%BB%AC%E7%9C%8BUNetConnection%E7%9A%84%E4%BB%A3%E7%A0%81%E5%8F%AF%E4%BB%A5%E9%AA%8C%E8%AF%81%E8%BF%99%E4%B8%80%E7%82%B9)。它还包含一个发送缓冲区 FBitWriter SendBuffer[*\[24\]*](https://blog.csdn.net/pizi0475/article/details/51780581#:~:text=1)，用于累积数据后发往底层网络。UNetConnection 还负责将 FOutBunch 发送到对端 Socket，并在接收数据时驱动 UChannel 进行反序列化。
* **UChannel / UActorChannel**：通道负责对单个对象进行数据流管理。UActorChannel 专门用于 AActor，实现了 ReplicateActor、SendBunch 等方法，将 Actor 的初始创建信息、属性变化和 RPC 一并通过该通道发送[*\[16\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/detailed-actor-replication-flow?application_version=4.27#:~:text=,flow%20looks%20something%20like%20this)。发送时，它会将参数写入 FOutBunch 并提交给 UNetConnection 发送，接收时则重组数据并触发逻辑调用。
* **FNetBitWriter / FOutBunch**：FOutBunch 是向外发送数据的比特写入器，继承自 FNetBitWriter[*\[10\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Engine/Net/FOutBunch#:~:text=Syntax)。它内部维护一个比特流和各种标志（如 bReliable、bOpen、bHasMustBeMappedGUIDs 等[*\[25\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Engine/Net/FOutBunch#:~:text=Type%20Name%20Description%20Image%3A%20Public,Public%20variable%20uint8%3A%201%20bIsReplicationPaused)）。在 RPC 过程中，参数数据会被写入 FOutBunch。FOutBunch 还包含诸如 ExportNetGUIDs（待导出的对象 GUID 列表）等成员[*\[19\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Engine/Net/FOutBunch#:~:text=Image%3A%20Public%20variable%20FString%20DebugString,58)，用于辅助对象引用的序列化。
* **FRepLayout**：封装了某个类型（Actor 类、结构体或函数）的复制属性布局[*\[26\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Engine/Net#:~:text=Image%3A%20Public%20class%20FRepLayout%20This,Public%20struct%20FReplayPlaylistParams%20Set%20of)。对于 RPC，FRepLayout 同样适用于函数参数，它记录了参数的顺序和各自的 UProperty。引擎通过 FRepLayout 的 SendPropertiesForRPC 和 SerializeProperties\_r 方法来编码和解码参数[*\[8\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=UNetDriver%3A%3AProcessRemoteFunctionForChannelPrivate%20void%20FRepLayout%3A%3ASendPropertiesForRPC%20FRepLayout%3A%3ASerializeProperties_r%20Cmd.Property,SerializeIntPacked%28%20NumPayloadBits)。
* **UFunction**：每个 RPC 函数对应一个 UFunction 元对象，其中函数标志位（如 FUNC\_NetServer、FUNC\_NetClient、FUNC\_NetMulticast）决定了调用行为。引擎在编译时已根据 UFUNCTION 标记生成好对应的调度代码，运行时根据这些标志执行网络调度。
* **FNetworkGUID (NetGUID)**：用于在网络上传递对象引用的全局唯一 ID[*\[20\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Core/Misc/FNetworkGUID#:~:text=class%20FNetworkGUID)。当 RPC 参数或属性包含 UObject\* 时，引擎会将目标对象转换为 FNetworkGUID，并在接收端通过 UNetConnection 的 PackageMap 将其映射回本地对象指针，以保持双方对同一对象的一致引用。

这些组件协同工作，构成了 UE5 的网络同步框架。除了上述核心，UE5 还引入了 **Iris Replication System**（实验性网络同步架构），以提升性能和可扩展性，但 Iris 在理念上也是基于相似的组件概念（不同的实现细节）。RPC 和属性复制均借助上述机制实现底层数据通信。

## 不同类型 RPC 的区分与调度 \[#不同类型-rpc-的区分与调度]

底层如何区分三种 RPC 类型？关键在于 UFunction 的标志位：- 客户端调用 Server RPC（FUNC\_NetServer）：只能在客户端本地调用。UNetDriver 拿到调用时，由客户端的连接发送到服务器。服务器端接到包后在 UNetDriver::ProcessRemoteFunction 中处理，并在服务器上调用目标函数逻辑[*\[5\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=%3C...%3E%20Connection%20%3D%20Actor,else)。- 服务器调用 Client RPC（FUNC\_NetClient）：服务器在本地调用，UNetDriver 需要把调用结果发给对应的客户端连接。这里就用到 Actor 的拥有关系：引擎只对拥有该 Actor 的客户端连接执行 RPC[*\[4\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=UNetConnection,NetConnection%20%3A%20NULL%3B)[*\[2\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/actor-owner-and-owning-connection-in-unreal-engine#:~:text=An%20actor%E2%80%99s%20owning%20connection%20is,send%20and%20execute%20the%20RPC)。在 InternalProcessRemoteFunctionForChannel 中，服务器为目标 Actor 找到对应的客户端连接（若没有则报错），然后通过该连接的 UActorChannel 发送 RPC 数据。- 服务器调用 Multicast RPC（FUNC\_NetMulticast）：服务器调用此 RPC 后，数据会被发送到所有关联该 Actor 的客户端（不局限于拥有者）。也就是说，UNetDriver 会遍历所有对该 Actor 打开了通道的连接，并对每个连接发送 RPC 数据[*\[2\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/actor-owner-and-owning-connection-in-unreal-engine#:~:text=An%20actor%E2%80%99s%20owning%20connection%20is,send%20and%20execute%20the%20RPC)。对于多播 RPC，调用时忽略拥有者，仅按 Actor 的所有连接广播。

调度方面，UNetDriver::ProcessRemoteFunction 在得到 UFunction 后会查看其网络标志，并选择合适的连接列表发送数据（在 Client RPC 情况下只发往拥有者，在 Multicast 情况下发往所有）[*\[2\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/actor-owner-and-owning-connection-in-unreal-engine#:~:text=An%20actor%E2%80%99s%20owning%20connection%20is,send%20and%20execute%20the%20RPC)。接收时，目标端判断是否执行：Client RPC 在客户端执行，Server RPC 在服务器执行，Multicast 在任意端依 Role 条件都会触发（通常服务器也立即执行一次）。

## 相关网络机制（NetDriver/NetConnection/NetGUID） \[#相关网络机制netdrivernetconnectionnetguid]

* **NetDriver**：UNetDriver 的实例代表一个网络会话的驱动程序。单机游戏中会创建一个 Server（LauncherNetDriver）监听客户端连接，客户端上有对应的 NetDriver。NetDriver 管理与该会话相关的所有 UNetConnection，并协调复制与 RPC。它还维护了一个 “对象所有表”(PackageMap) 用于跟踪所有需要复制的对象和它们的 NetGUID，用于处理跨主机的对象查找。
* **NetConnection**：正如前文所述，每个客户端与服务器之间都有一个 UNetConnection。它包含一个发送缓冲（FBitWriter SendBuffer）和多个 UChannel（包括一个或多个 UActorChannel）。它负责把高层数据（Actor状态、RPC参数等）转换成网络数据包，通过底层传输发送，并在接收时反向解析。
* **NetGUID**：如上所述，通过 FNetworkGUID 唯一标识网络中的对象。引擎中还有 PackageMapClient 和 PackageMap 等组件负责在发送对象指针时，将其映射为 GUID，然后在接收端找到对应的实例。例如，FOutBunch 中的 bHasMustBeMappedGUIDs 标志和 ExportNetGUIDs 列表[*\[25\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Engine/Net/FOutBunch#:~:text=Type%20Name%20Description%20Image%3A%20Public,Public%20variable%20uint8%3A%201%20bIsReplicationPaused)[*\[19\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Engine/Net/FOutBunch#:~:text=Image%3A%20Public%20variable%20FString%20DebugString,58)指示当前包中包含哪些对象需要映射。网络层会根据这些信息调用 PackageMap 来解析 GUID，完成对象引用的同步。

以上机制共同保证了 UE5 的网络同步功能：RPC 通过连接和通道进行点对点的函数调用，属性和对象复制通过相同的通道进行广播式的数据同步，而 NetDriver/NetConnection/NetGUID 等组件则提供了基础的网络拓扑与数据映射支持[*\[21\]*](https://blog.csdn.net/pizi0475/article/details/51780581#:~:text=1.%20class%C2%A0UNetConnection)[*\[19\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Engine/Net/FOutBunch#:~:text=Image%3A%20Public%20variable%20FString%20DebugString,58)。综合以上内容，可见 Unreal Engine 5 的 RPC 底层实现紧密依赖其反射系统、UChannel 网络通道以及可靠UDP/IP 等网络层组件，提供了完整的端到端 RPC 调用流程。

**参考资料：** 以上分析参考了 Epic 官方文档[*\[12\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/detailed-actor-replication-flow?application_version=4.27#:~:text=The%20bulk%20of%20actor%20replication,each%20connected%20client%20was%20updated)[*\[16\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/detailed-actor-replication-flow?application_version=4.27#:~:text=,flow%20looks%20something%20like%20this)[*\[2\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/actor-owner-and-owning-connection-in-unreal-engine#:~:text=An%20actor%E2%80%99s%20owning%20connection%20is,send%20and%20execute%20the%20RPC)、UE 源码解析与社区技术文章[*\[1\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=%E6%89%80%E6%9C%89%E7%9A%84RPC%E9%83%BD%E9%9C%80%E8%A6%81%E5%A3%B0%E6%98%8E%E4%B8%BAUFUNCTION%E3%80%82%E5%9C%A8Unreal%E5%86%85%E9%83%A8%E6%9C%89%E4%B8%89%E7%A7%8DRPC%E6%9C%BA%E5%88%B6%EF%BC%8C)[*\[5\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=%3C...%3E%20Connection%20%3D%20Actor,else)[*\[3\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=1%20They%20must%20be%20called,Multicast%20RPCs%20are%20an%20exception)[*\[9\]*](https://blog.csdn.net/pizi0475/article/details/51780581#:~:text=1.%20UActorChannel%2A%C2%A0Ch%C2%A0%3D%C2%A0Connection)[*\[10\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Engine/Net/FOutBunch#:~:text=Syntax)，以及 CSDN 博客对 UNetDriver/UNetConnection 的研究[*\[21\]*](https://blog.csdn.net/pizi0475/article/details/51780581#:~:text=1.%20class%C2%A0UNetConnection)[*\[24\]*](https://blog.csdn.net/pizi0475/article/details/51780581#:~:text=1)等。

***

[*\[1\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=%E6%89%80%E6%9C%89%E7%9A%84RPC%E9%83%BD%E9%9C%80%E8%A6%81%E5%A3%B0%E6%98%8E%E4%B8%BAUFUNCTION%E3%80%82%E5%9C%A8Unreal%E5%86%85%E9%83%A8%E6%9C%89%E4%B8%89%E7%A7%8DRPC%E6%9C%BA%E5%88%B6%EF%BC%8C) [*\[3\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=1%20They%20must%20be%20called,Multicast%20RPCs%20are%20an%20exception) [*\[4\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=UNetConnection,NetConnection%20%3A%20NULL%3B) [*\[5\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=%3C...%3E%20Connection%20%3D%20Actor,else) [*\[6\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=static%20FName%20NAME_ACharacter_ServerMovePacked%20%3D%20FName%28TEXT%28,Character_eventServerMovePacked_Parms%20Parms%3B%20Parms.PackedBits%3DPackedBits) [*\[7\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=1,%E5%9F%BA%E4%BA%8E%E4%BB%A5%E4%B8%8A%E4%B8%A4%E7%82%B9%EF%BC%8CUnreal%E5%8F%AF%E4%BB%A5%E6%96%B9%E4%BE%BF%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%B1%9E%E6%80%A7%E7%9A%84%E7%BC%96%E7%A0%81%E8%A7%A3%E7%A0%81%EF%BC%8C%E4%BB%A5%E5%8F%8A%E8%BF%9C%E7%A8%8B%E8%BF%87%E7%A8%8B%E5%87%BD%E6%95%B0%E5%8F%8A%E5%85%B6%E5%8F%82%E6%95%B0%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%8C%E5%B9%B6%E5%AE%9E%E7%8E%B0%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E3%80%82) [*\[8\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=UNetDriver%3A%3AProcessRemoteFunctionForChannelPrivate%20void%20FRepLayout%3A%3ASendPropertiesForRPC%20FRepLayout%3A%3ASerializeProperties_r%20Cmd.Property,SerializeIntPacked%28%20NumPayloadBits) [*\[11\]*](https://cloud.tencent.com/developer/article/2275914#:~:text=%E8%BF%99%E9%87%8C%E4%BB%8D%E7%84%B6%E6%9C%89%E5%87%A0%E4%B8%AA%E5%B0%8F%E7%BB%86%E8%8A%82%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%BC%BA%E8%B0%83%E4%B8%8B%EF%BC%9A) UE网络通信（四）RPC&移动通信-腾讯云开发者社区-腾讯云

[*https://cloud.tencent.com/developer/article/2275914*](https://cloud.tencent.com/developer/article/2275914)

[*\[2\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/actor-owner-and-owning-connection-in-unreal-engine#:~:text=An%20actor%E2%80%99s%20owning%20connection%20is,send%20and%20execute%20the%20RPC) Actor Owner and Owning Connection in Unreal Engine | Unreal Engine 5.6 Documentation | Epic Developer Community

[*https://dev.epicgames.com/documentation/en-us/unreal-engine/actor-owner-and-owning-connection-in-unreal-engine*](https://dev.epicgames.com/documentation/en-us/unreal-engine/actor-owner-and-owning-connection-in-unreal-engine)

[*\[9\]*](https://blog.csdn.net/pizi0475/article/details/51780581#:~:text=1.%20UActorChannel%2A%C2%A0Ch%C2%A0%3D%C2%A0Connection) [*\[21\]*](https://blog.csdn.net/pizi0475/article/details/51780581#:~:text=1.%20class%C2%A0UNetConnection) [*\[23\]*](https://blog.csdn.net/pizi0475/article/details/51780581#:~:text=nnel%EF%BC%8C%E6%88%91%E4%BB%AC%E7%9C%8BUNetConnection%E7%9A%84%E4%BB%A3%E7%A0%81%E5%8F%AF%E4%BB%A5%E9%AA%8C%E8%AF%81%E8%BF%99%E4%B8%80%E7%82%B9) [*\[24\]*](https://blog.csdn.net/pizi0475/article/details/51780581#:~:text=1) ue4 网络代码分析\_虚幻 fnetbitwriter-CSDN博客

[*https://blog.csdn.net/pizi0475/article/details/51780581*](https://blog.csdn.net/pizi0475/article/details/51780581)

[*\[10\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Engine/Net/FOutBunch#:~:text=Syntax) [*\[19\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Engine/Net/FOutBunch#:~:text=Image%3A%20Public%20variable%20FString%20DebugString,58) [*\[25\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Engine/Net/FOutBunch#:~:text=Type%20Name%20Description%20Image%3A%20Public,Public%20variable%20uint8%3A%201%20bIsReplicationPaused) FOutBunch | Unreal Engine 5.6 Documentation | Epic Developer Community

[*https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Engine/Net/FOutBunch*](https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Engine/Net/FOutBunch)

[*\[12\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/detailed-actor-replication-flow?application_version=4.27#:~:text=The%20bulk%20of%20actor%20replication,each%20connected%20client%20was%20updated) [*\[13\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/detailed-actor-replication-flow?application_version=4.27#:~:text=,relevant%20list%20on%20the%20connection) [*\[14\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/detailed-actor-replication-flow?application_version=4.27#:~:text=,is%20called) [*\[15\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/detailed-actor-replication-flow?application_version=4.27#:~:text=,add%20to%20the%20considered%20list) [*\[16\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/detailed-actor-replication-flow?application_version=4.27#:~:text=,flow%20looks%20something%20like%20this) [*\[17\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/detailed-actor-replication-flow?application_version=4.27#:~:text=,UChannel%3A%3AReplicateActor) [*\[18\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/detailed-actor-replication-flow?application_version=4.27#:~:text=,add%20to%20the%20considered%20list) Detailed Actor Replication Flow | Unreal Engine 4.27 Documentation | Epic Developer Community

[*https://dev.epicgames.com/documentation/en-us/unreal-engine/detailed-actor-replication-flow?application\_version=4.27*](https://dev.epicgames.com/documentation/en-us/unreal-engine/detailed-actor-replication-flow?application_version=4.27)

[*\[20\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Core/Misc/FNetworkGUID#:~:text=class%20FNetworkGUID) FNetworkGUID | Unreal Engine 5.6 Documentation | Epic Developer Community

[*https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Core/Misc/FNetworkGUID*](https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Core/Misc/FNetworkGUID)

[*\[22\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Engine/Engine/UNetDriver/ProcessRemoteFunction#:~:text=virtual%20void%20ProcessRemoteFunction%20,SubObject) UNetDriver::ProcessRemoteFunction | Unreal Engine 5.6 Documentation | Epic Developer Community

[*https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Engine/Engine/UNetDriver/ProcessRemoteFunction*](https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Engine/Engine/UNetDriver/ProcessRemoteFunction)

[*\[26\]*](https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Engine/Net#:~:text=Image%3A%20Public%20class%20FRepLayout%20This,Public%20struct%20FReplayPlaylistParams%20Set%20of) Net | Unreal Engine 5.6 Documentation | Epic Developer Community

[*https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Engine/Net*](https://dev.epicgames.com/documentation/en-us/unreal-engine/API/Runtime/Engine/Net)
